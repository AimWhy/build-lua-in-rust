# 前言

Rust语言个性鲜明，[备受青睐](https://survey.stackoverflow.co/2022/?utm_source=so-owned&utm_medium=announcement-banner&utm_campaign=dev-survey-2022&utm_content=results#section-most-loved-dreaded-and-wanted-programming-scripting-and-markup-languages)，然而学习曲线陡峭。我在读完[《Rust程序设计语言》](https://kaisery.github.io/trpl-zh-cn/)之后，被各种新概念搞的晕头转向，深知必须通过项目实践才能消化和吸收。而实现一个Lua解释器就非常适合作为这个练习，原因如下：

- 规模适中。足够复杂，应用场景多样，涉及到Rust诸多特性；同时又没有复杂到难以掌握，以至于要花更多精力在项目本身而非语言学习上。

- 目标明确。[Lua语言手册](https://www.lua.org/manual/5.4/)就是完整且明确的需求文档。

- 较少理论依赖。虽然语言解释器或者说编译原理是个小众且晦涩的领域，但Lua语言相对精简，并且有开源的官方实现作为参考，所以并不需要太多理论知识准备，可以直接上手。

- 同时学习Lua。Lua本身也是个特点突出的语言，其官方实现更是公认优秀的开源项目。通过实现一个Lua解释器，不仅能对Lua语言及其实现有彻底的理解，还能举一反三对解释型语言有大体的认识。

这里有个[各种Lua解释器实现](http://lua-users.org/wiki/LuaImplementations)的列表，这也足以说明实现一个Lua解释器是多么吸引人。希望以后我的这个版本也能罗列其中。

这么做当然也有缺点。相比于[《通过例子学Rust》](https://rustwiki.org/zh-CN/rust-by-example/)这类针对性的练习书籍，用实现Lua解释器来学习Rust的效率实在太低，还是要花一定比例的精力在Lua语言上，具体比例取决于对Rust、Lua和编译原理分别的了解程度。不过，付出总有收获。遇到的困难越多，收获就越多；遇到的困难越大，收获就越大。都是值得的。

这种从零开始逐步实现一个完整项目是令人激动的：明确的大目标，未知的探索过程，足够的动力，持续的成就感，以及最后极大的收获。甚至有个[Build your own X](https://build-your-own-x.vercel.app/)的列表。实现一个Lua解释器也是这样的项目，于是我就想把这个过程也记录下来，然后就有了这系列文章。虽然都是从零开始的项目，但跟上述列表中的大多数相比，我们的项目和文章有几个不同之处：

- 上述列表中大部分作者都是在相关领域浸淫多年，有着丰富的理论和实践经验，并对项目配以深入浅出的介绍。而我的工作并不是编程语言或编译原理方向，对于实现一个解释器而言并没有完整的理论知识，纯粹摸着石头过河。没有高屋建瓴和旁征博引，自然会降低文章内容的高度；不过凡事要往好处想，这也提供了一个真正的初学者视角。

- 上述列表中大部分项目都是以学习或教学为目的，去繁从简，实现一个只具备最基本功能的原型。而我的目标是实现一个生产级别的Lua解释器，所以会在稳定、完整、和性能方面有所追求。

- 上述列表中大部分的主要目标都是项目本身，而使用的语言只是工具。而我的初衷是学习Rust语言，所以文章中也会有一些我对Rust语言的学习笔记和使用心得。

这系列文章并不会介绍Rust和Lua的基本语法，预期读者对这两门语言都有基本的了解。其中对Lua语言自然是越熟悉越好，不过如果不熟悉无非也就是多花时间阅读Lua语言手册。对Rust语言则无高要求，只要读过《Rust程序设计语言》，了解基本语法即可，毕竟这个项目的初衷就是为了学习Rust。

内容安排如下。第1章实现一个最小的、只能解析 `print "hello, world!"` 语句的解释器。虽然简单，但是包括了解释器的完整流程，构建了基本框架。后续章节就以Lua语言特性为出发点，在这个最小解释器上逐渐地增加功能。第2章介绍编程语言中最基本的类型和变量的概念。第3章以完善字符串类型为目标，介绍Rust语言的几个特性。第4章实现Lua中的表结构，并引入语法分析中关键的ExpDesc概念。第5章是繁琐的数值计算。第6章控制结构，事情开始变得有趣起来，根据判断语句跳来跳去。第7章把逻辑运算和关系运算与第6章的控制结构相结合，情况变得不那么简单。第8章的函数XXX。

每一章都从Lua功能特性出发，先讨论如何设计，再介绍具体实现。不仅要讲清楚“怎么做”，更重要的是讲清楚“为什么这么做”，坚决杜绝写成代码阅读笔记。

每一章都有完整的可运行代码，并且每一章的代码都是基于前一章的最终代码，保证整个项目是连续的。每个小节对应的代码改动都集中在两三个commit中，可以通过git来查看变更历史。

相比于编程语言，我的自然语言表达能力差太多，所以文中尽量多用列表和图表，以求表达清晰。但必定还是会有描述不清的地方，欢迎来项目的[github主页](https://github.com/WuBingzheng/build-lua-in-rust)提issue反馈。如果有技术方面的错误，也欢迎指正。