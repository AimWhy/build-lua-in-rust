# 前言

我在一年多前开始学习Rust语言。先是读完了《Rust程序设计语言》，感觉似懂非懂。可能是因为我之前主要使用古老又简单的C语言，所以这本书里介绍的太多的Rust特性让我难以消化。虽然还有一些其他的入门教程和书籍，但我觉得此时更需要的是动手实践！于是我写了几个小程序，体验了Rust特有的借用机制和严格的编译器，但都没有涉及到更多的Rust特性，只是隔靴搔痒。然后就想着找个稍微复杂点的练习，于是就有了这个项目，实现一个Lua解释器。在后面的开发过程中，我也逐渐发现这确实是一个非常好的练习项目：

- 足够复杂。毕竟是实现一个完整的语言解释器，会涉及到《Rust程序设计语言》书中介绍的大部分特性。
- 但又不至于太过复杂。Lua语言非常轻量，我们有能力实现Lua的全部特性，并且还能追求性能。相比于只做原型验证性质的开发，对特性和性能的追求往往对实现有更高的要求，也就是对Rust语言更深的理解。
- 需求明确且具体。按照Lua语言手册实现即可，不必花费大量时间和精力去设计功能特性。
- 理论要求不高，只涉及到一点点编译原理的概念。容易上手。
- Lua是一门优秀且应用广泛的语言。实现一个Lua解释器就是对Lua的一次全面深入的学习，这也是非常实用的收获。
- Lua的官方实现也是公认的优秀（类似的优秀C语言项目还有redis和nginx），但单纯去读源码是很枯燥的。而当我们在开发过程中带着问题去读，就更有目的性。这也是对优秀开源项目的学习。

我后来还发现了个包含非常多实现的[列表](http://lua-users.org/wiki/LuaImplementations)，这也足以证明实现Lua解释器是多么吸引人。希望我的这个版本以后也能罗列其中。

我在做完这个项目后，不仅全面深入地学习了一遍Lua，也达到了最初的实践Rust的目的。一举两得。

## 为什么要写这系列笔记

技术方面对我影响最大的一本书，是我在上学期间读到的于渊的《自己动手写操作系统》。这本书让我完成了从学生到工程师的转变。我也非常喜欢这种从零开始完成一个完整工程的做法。明确的大目标，未知的探索过程，足够的动力，持续的成就感，以及最后极大的收获。应该有不少人有类似的想法，甚至有个[Build your own X](https://build-your-own-x.vercel.app/)的列表。而用Rust实现Lua解释器就是这样一种经历。于是我就有了把这个过程也记录下来并分享出去的想法。

我开始对此也很犹豫。一是因为我对编译原理、编译器和解释器等的了解止步于学校的课本知识，二是我的文字表达能力非常差。不过在项目期间，我看到了一些博客([1](https://mp.weixin.qq.com/s/qA9zcMnt7UayHZ1VsOkFXA)，[2](https://jvns.ca/blog/2016/05/22/how-do-you-write-blog-posts/)) ，都是鼓励写作的。不要害怕陌生的领域，不要害怕表达。写出来，是最好的学习方法。听上去都很有道理的样子。于是我也决心把这个项目的开发过程写下来。

## 内容

工作中的项目，都是先确定需求，再整体设计，再详细设计，最后再写代码。这么做的前提是要有完全掌控需求、设计和实现的能力。而开始我们对编译原理、解释器设计与实现、Lua全部特性、甚至Rust编程都一知半解，所以没有能力走这个“正规”流程。而要先把这些内容全学一遍要花太多时间。为了不偏离最初的目标（练习Rust语言）太远，我们需要尽快进入编码阶段，所以这次选择边学习边摸索边写代码的模式。就像以前没有旅游攻略没有手机导航的时候出去旅游，虽然肯定会走错路走弯路，但只要把路上的风景XXX，那么就是值得的。

这系列笔记基本就是按照我当初做项目过程的顺序。首先，我们会先制作一个极简的Lua解释器：只能解释`print "hello, world!"`这句Lua代码。麻雀虽小，五脏俱全。这个解释器有完整的词法解析、语法解析和虚拟机执行流程。然后，再在这个解释器基础上，按照由易到难的顺序逐渐添加Lua特性。并且也随着对Rust的不断了解，持续优化代码。最终完成一个全特性且高性能的Lua解释器（其实都会差一点点）。

在这个过程中，会遇到Lua语言方面的问题，比如泛型for的语法；也会遇到具体实现的问题，比如upvalue的escape；更多的是在跟Rust编译器做斗争。我会把遇到的问题、解决方案、以及中间的一些思考过程都记录下来。当然还有每一章的完整代码。遇到的困难越多，收获就越多。遇到的困难越大，收获就越大。

但这里并不打算介绍Rust和Lua的基本语法问题。所以预期读者对这两门语言都有基本的了解。更具体地说，由于我们对Rust的目标就是迈出《Rust程序设计语言》的下一步，所以只要读过这本书就够了。但我们对Lua的目标可是要实现它的，所以对Lua的要求就会高一些，越熟悉越好。


lua版本选择

##

- C++是这样的而Rust是那样的。
- C没有这个。。。